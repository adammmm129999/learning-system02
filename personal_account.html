<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ä¿®æ”¹å€‹äººè³‡æ–™</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      background-color: #fefefe;
      color: #333;
    }

    /* å°è¦½åˆ—ç¶­æŒåŸæœ¬è¨­å®š */
.navbar {
  background-color: #4a90e2;
  padding: 16px;
  text-align: center;
  z-index: 10;
}

/* å°è¦½åˆ—æ–‡å­—é¡è‰² */
.navbar a {
  color: white;
  text-decoration: none;
  margin: 0 12px;
  font-size: 20px;
}
    h1 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 15px;
      color: #333;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 25px;
      border-radius: 6px;
    }
    .avatar-preview {
      text-align: center;
      margin-top: 15px;
    }
    .avatar-preview img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid #007bff;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="home.html">ğŸ  é¦–é </a>
      <a href="course.html">ğŸ“˜ èª²ç¨‹æ•™å­¸</a>
      <a href="discussion.html">ğŸ’¬ è¨è«–å€</a>    
      <a href="personal_account.html">å€‹äººè³‡æ–™ğŸ“„</a>
      
    </div>
  </nav>
  <h1>ä¿®æ”¹å€‹äººè³‡æ–™</h1>

  <form id="accountForm">
    <label for="name">å§“å</label>
    <input type="text" id="name" required>

    <label for="email">é›»å­éƒµä»¶</label>
    <input type="email" id="email" required>

    <label for="phone">é›»è©±</label>
    <input type="tel" id="phone">

    <label for="avatar">ä¸Šå‚³é ­åƒ</label>
    <input type="file" id="avatar" accept="image/*">

    <div class="avatar-preview" id="avatarPreview"></div>

    <button type="submit">å„²å­˜ä¿®æ”¹</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateEmail } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    // âœ… è«‹æ›æˆä½ è‡ªå·±çš„ Firebase è¨­å®š
    const firebaseConfig = {
 apiKey: "AIzaSyC0VF7SkuXvOAJyuC-2tPl_KGris3f4gqE",
  authDomain: "final-project-fb104.firebaseapp.com",
  projectId: "final-project-fb104",
  storageBucket: "final-project-fb104.appspot.com",
  messagingSenderId: "150740541108",
  appId: "1:150740541108:web:1a0dba9ebb4cbb157001e1",
  measurementId: "G-XRR8QBXS35"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const avatarInput = document.getElementById('avatar');
    const avatarPreview = document.getElementById('avatarPreview');
    const form = document.getElementById('accountForm');

    let currentUser = null;
    let avatarFile = null;
    let avatarPath = null;

    // é è¦½é ­åƒ
    avatarInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) {
        avatarFile = null;
        avatarPreview.innerHTML = "";
        return;
      }

      if (!file.type.startsWith("image/")) {
        alert("è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ");
        avatarInput.value = "";
        return;
      }

      avatarFile = file;
      const reader = new FileReader();
      reader.onload = e => {
        avatarPreview.innerHTML = `<img src="${e.target.result}" alt="é è¦½åœ–">`;
      };
      reader.readAsDataURL(file);
    });

    // è®€å–ç”¨æˆ¶è³‡æ–™
    async function loadUserData(uid) {
      try {
        const docSnap = await getDoc(doc(db, "users", uid));
        if (docSnap.exists()) {
          const data = docSnap.data();
          nameInput.value = data.name || "";
          phoneInput.value = data.phone || "";
          if (data.avatarPath) {
            const url = await getDownloadURL(ref(storage, data.avatarPath));
            avatarPreview.innerHTML = `<img src="${url}" alt="é ­åƒ">`;
            avatarPath = data.avatarPath;
          }
        }
        emailInput.value = auth.currentUser.email || "";
      } catch (err) {
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼š" + err.message);
      }
    }

    // å„²å­˜ä¿®æ”¹
    form.addEventListener("submit", async e => {
      e.preventDefault();
      if (!currentUser) return alert("è«‹å…ˆç™»å…¥");

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const phone = phoneInput.value.trim();

      try {
        if (email !== currentUser.email) {
          await updateEmail(currentUser, email);
        }
      } catch (err) {
        return alert("æ›´æ–° Email å¤±æ•—ï¼š" + err.message);
      }

      let newAvatarPath = avatarPath;
      if (avatarFile) {
        const fileRef = ref(storage, `avatars/${currentUser.uid}/${avatarFile.name}`);
        await uploadBytes(fileRef, avatarFile);
        newAvatarPath = fileRef.fullPath;
      }

      try {
        await setDoc(doc(db, "users", currentUser.uid), {
          name,
          phone,
          avatarPath: newAvatarPath,
          updatedAt: new Date()
        }, { merge: true });

        alert("æ›´æ–°æˆåŠŸï¼");
      } catch (err) {
        alert("å„²å­˜è³‡æ–™å¤±æ•—ï¼š" + err.message);
      }
    });

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadUserData(user.uid);
      } else {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
